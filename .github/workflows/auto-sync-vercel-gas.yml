name: Auto Sync GAS URL to Vercel

on:
  push:
    paths:
      - 'config/gas_url.txt'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Read GAS_URL
        id: read_gas
        run: |
          if [ ! -f config/gas_url.txt ]; then
            echo "File config/gas_url.txt not found" >&2
            exit 1
          fi
          GAS=$(cat config/gas_url.txt | tr -d '\r' | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
          if [ -z "$GAS" ]; then
            echo "GAS_URL is empty" >&2
            exit 1
          fi
          echo "gas_url=$GAS" >> $GITHUB_OUTPUT

      - name: Upsert GAS_URL into Vercel (upsert=true)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          set -e
          # If you prefer to use secret for project id, set secrets.VERCEL_PROJECT; otherwise we use the provided project id below
          PROJECT_ID="${{ secrets.VERCEL_PROJECT || 'prj_O1afEEeDqFf1QkVUc4WMBbhGOINV' }}"
          GAS_URL="${{ steps.read_gas.outputs.gas_url }}"

          echo "Updating Vercel project $PROJECT_ID with GAS_URL=$GAS_URL"

          read -r -d '' PAYLOAD <<EOF || true
[{
  "key": "GAS_URL",
  "value": "$GAS_URL",
  "type": "plain",
  "target": ["preview","production"]
}]
EOF

          API="https://api.vercel.com/v10/projects/${PROJECT_ID}/env?upsert=true"
          HTTP_STATUS=$(curl -s -o /tmp/resp.json -w "%{http_code}" \
            -X POST "$API" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          echo "Vercel API status: $HTTP_STATUS"
          cat /tmp/resp.json
          if [ "$HTTP_STATUS" -ge 400 ]; then
            echo "Failed to update env var (status $HTTP_STATUS)" >&2
            exit 1
          fi

      - name: Trigger Deploy Hook (optional)
        if: secrets.VERCEL_DEPLOY_HOOK != ''
        run: |
          echo "Triggering deploy hook..."
          curl -s -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}" || true
          echo "Deploy hook called."
